generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id            String   @id @default(cuid())
  wallet        String   @unique
  pda           String   @unique
  owner         String
  metadataUri   String
  registeredAt  DateTime
  isVerified    Boolean  @default(false)
  verifiedAt    DateTime?
  sponsored     Boolean  @default(false)  // Was registration sponsored (free)?
  
  // Extended metadata (cached from AgentCard)
  name          String?
  description   String?
  twitter       String?
  website       String?
  image         String?  // Avatar/profile picture URL
  
  // Service endpoints
  mcpEndpoint   String?
  a2aEndpoint   String?
  x402Wallet    String?
  serviceTypes  String[]  @default([])
  skills        String[]  @default([])
  
  // Reputation
  reputationScore Float   @default(0)
  feedbackCount   Int     @default(0)
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastSyncedAt  DateTime @default(now())
  
  // Relations
  feedbackReceived Feedback[] @relation("FeedbackReceived")
  feedbackGiven    Feedback[] @relation("FeedbackGiven")
  attestationsReceived Attestation[] @relation("AttestationsReceived")
  attestationsGiven    Attestation[] @relation("AttestationsGiven")
  createdByUsers   UserAgent[]

  @@index([name])
  @@index([reputationScore])
  @@index([isVerified])
}

model Feedback {
  id          String   @id @default(cuid())
  
  // Who gave feedback
  fromWallet  String
  fromAgent   Agent?   @relation("FeedbackGiven", fields: [fromWallet], references: [wallet])
  
  // Who received feedback
  toWallet    String
  toAgent     Agent    @relation("FeedbackReceived", fields: [toWallet], references: [wallet])
  
  // Feedback content
  score       Int      // 0-100
  comment     String?
  weight      Float    @default(1.0)  // Verified agents = 2.0, others = 1.0
  
  // Verification
  signature   String   // Wallet signature proving authenticity
  fromIsVerified Boolean @default(false) // Was giver verified at time of feedback?
  txHash      String?  // On-chain hash if stored on-chain
  
  createdAt   DateTime @default(now())

  @@unique([fromWallet, toWallet])
  @@index([toWallet])
  @@index([score])
}

model SyncState {
  id          String   @id @default("main")
  lastSlot    BigInt   @default(0)
  lastSyncAt  DateTime @default(now())
}

model AgentCard {
  id          String   @id @default(cuid())
  wallet      String   @unique
  cardJson    String   // JSON blob of the agent card
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([wallet])
}

model Attestation {
  id              String    @id @default(cuid())
  
  // Who is attesting
  attesterWallet  String
  attester        Agent     @relation("AttestationsGiven", fields: [attesterWallet], references: [wallet])
  
  // Who is being attested
  subjectWallet   String
  subject         Agent     @relation("AttestationsReceived", fields: [subjectWallet], references: [wallet])
  
  // Attestation details
  type            String    @default("trust")  // trust, endorsement, interaction, skill
  confidence      Int       @default(50)       // 1-100
  context         String?                      // Optional note/reason
  skill           String?                      // For skill attestations: which skill
  
  // Verification
  signature       String?                      // Wallet signature (optional for trusted sources)
  txHash          String?                      // On-chain anchor (future)
  
  // Lifecycle
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  revokedAt       DateTime?
  
  @@unique([attesterWallet, subjectWallet, type])
  @@index([subjectWallet])
  @@index([attesterWallet])
  @@index([type])
}

model User {
  id              String    @id @default(cuid())
  
  // Login methods (one of these is set)
  walletAddress   String?   @unique
  email           String?   @unique
  emailVerified   Boolean   @default(false)
  
  // Profile
  displayName     String?
  
  // Session management
  sessionToken    String?   @unique
  sessionExpiry   DateTime?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLoginAt     DateTime  @default(now())
  
  // Relations
  agents          UserAgent[]
  
  @@index([walletAddress])
  @@index([email])
  @@index([sessionToken])
}

model UserAgent {
  id              String    @id @default(cuid())
  
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  agentWallet     String
  agent           Agent     @relation(fields: [agentWallet], references: [wallet], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())
  
  @@unique([userId, agentWallet])
  @@index([userId])
  @@index([agentWallet])
}
